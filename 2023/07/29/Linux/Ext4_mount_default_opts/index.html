<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"cyyzero.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"buttons","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="引入在Ext4的官方文档里，可以看到有很多挂载的选项，并且有一些被标记为了默认，比如delalloc。但是通过procfs的&#x2F;proc&#x2F;mounts并没有看到这些默认的选项，比如delalloc（有个nodelalloc的disable delalloc选项，这两个是非此即彼的关系，却都没有出现）。 12$ cat &#x2F;proc&#x2F;mounts| grep ext4&#x2F;dev&#x2F;sdb &#x2F; ext4 rw">
<meta property="og:type" content="article">
<meta property="og:title" content="ext4文件系统默认挂载选项">
<meta property="og:url" content="http://cyyzero.github.io/2023/07/29/Linux/Ext4_mount_default_opts/index.html">
<meta property="og:site_name" content="Eden">
<meta property="og:description" content="引入在Ext4的官方文档里，可以看到有很多挂载的选项，并且有一些被标记为了默认，比如delalloc。但是通过procfs的&#x2F;proc&#x2F;mounts并没有看到这些默认的选项，比如delalloc（有个nodelalloc的disable delalloc选项，这两个是非此即彼的关系，却都没有出现）。 12$ cat &#x2F;proc&#x2F;mounts| grep ext4&#x2F;dev&#x2F;sdb &#x2F; ext4 rw">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-07-29T17:08:29.000Z">
<meta property="article:modified_time" content="2023-10-29T07:13:44.879Z">
<meta property="article:author" content="Yiyang Chen">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://cyyzero.github.io/2023/07/29/Linux/Ext4_mount_default_opts/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://cyyzero.github.io/2023/07/29/Linux/Ext4_mount_default_opts/","path":"2023/07/29/Linux/Ext4_mount_default_opts/","title":"ext4文件系统默认挂载选项"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ext4文件系统默认挂载选项 | Eden</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Eden" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Eden</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E5%85%A5"><span class="nav-number">1.</span> <span class="nav-text">引入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#procfs%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">2.</span> <span class="nav-text">procfs的数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#proc-pid-mounts"><span class="nav-number">2.1.</span> <span class="nav-text">&#x2F;proc&#x2F;{pid}&#x2F;mounts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#proc-fs-ext4-device-options"><span class="nav-number">2.2.</span> <span class="nav-text">&#x2F;proc&#x2F;fs&#x2F;ext4&#x2F;{device}&#x2F;options</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E6%8C%82%E8%BD%BD%E9%80%89%E9%A1%B9"><span class="nav-number">3.</span> <span class="nav-text">默认挂载选项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yiyang Chen"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Yiyang Chen</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/cyyzero" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cyyzero" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:cyyzero@qq.com" title="E-Mail → mailto:cyyzero@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/9748477/cyyzero" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;9748477&#x2F;cyyzero" rel="noopener me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://cyyzero.github.io/2023/07/29/Linux/Ext4_mount_default_opts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yiyang Chen">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eden">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ext4文件系统默认挂载选项 | Eden">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ext4文件系统默认挂载选项
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-29 17:08:29" itemprop="dateCreated datePublished" datetime="2023-07-29T17:08:29+00:00">2023-07-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-29 07:13:44" itemprop="dateModified" datetime="2023-10-29T07:13:44+00:00">2023-10-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>在<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v4.19/filesystems/ext4/ext4.html#options">Ext4的官方文档</a>里，可以看到有很多挂载的选项，并且有一些被标记为了默认，比如<code>delalloc</code>。但是通过<code>procfs</code>的<code>/proc/mounts</code>并没有看到这些默认的选项，比如<code>delalloc</code>（有个<code>nodelalloc</code>的disable delalloc选项，这两个是非此即彼的关系，却都没有出现）。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/mounts| grep ext4</span><br><span class="line">/dev/sdb / ext4 rw,relatime,discard,errors=remount-ro,data=ordered 0 0</span><br></pre></td></tr></table></figure>

<p>而对于另一个文件系统相关的文件里，却能够看到这些完整的选项：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /proc/fs/ext4/sdb/options    </span><br><span class="line">rw</span><br><span class="line">bsddf</span><br><span class="line">nogrpid</span><br><span class="line">block_validity</span><br><span class="line">dioread_nolock</span><br><span class="line">discard</span><br><span class="line">delalloc</span><br><span class="line">nowarn_on_error</span><br><span class="line">journal_checksum</span><br><span class="line">barrier</span><br><span class="line">auto_da_alloc</span><br><span class="line">user_xattr</span><br><span class="line">acl</span><br><span class="line">noquota</span><br><span class="line">resuid=0</span><br><span class="line">resgid=0</span><br><span class="line">errors=remount-ro</span><br><span class="line">commit=5</span><br><span class="line">min_batch_time=0</span><br><span class="line">max_batch_time=15000</span><br><span class="line">stripe=0</span><br><span class="line">data=ordered</span><br><span class="line">inode_readahead_blks=32</span><br><span class="line">init_itable=10</span><br><span class="line">max_dir_size_kb=0</span><br></pre></td></tr></table></figure>

<p>带着这个问题，基于6.1.36内核源码，梳理了文件系统如何通过<code>procfs</code>来展示挂载信息，并且在创建和挂载文件系统时如何处理挂载选项。</p>
<h2 id="procfs的数据"><a href="#procfs的数据" class="headerlink" title="procfs的数据"></a>procfs的数据</h2><h3 id="proc-pid-mounts"><a href="#proc-pid-mounts" class="headerlink" title="&#x2F;proc&#x2F;{pid}&#x2F;mounts"></a>&#x2F;proc&#x2F;{pid}&#x2F;mounts</h3><p>由于有了mount namespace，系统挂载点可以在各个进程之间相互隔离，不再是全局一致。所以<code>/proc/mounts</code>其实是指向<code>/proc/self/mounts</code>的符号链接。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -l /proc/mounts</span><br><span class="line">lrwxrwxrwx 1 root root 11 Jul 30 05:31 /proc/mounts -&gt; self/mounts</span><br></pre></td></tr></table></figure>

<p>展示的函数是<code>show_vfsmnt</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/proc_namespace.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">show_vfsmnt</span><span class="params">(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> vfsmount *mnt)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">proc_mounts</span> *<span class="title">p</span> =</span> m-&gt;private;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mount</span> *<span class="title">r</span> =</span> real_mount(mnt);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">mnt_path</span> =</span> &#123; .dentry = mnt-&gt;mnt_root, .mnt = mnt &#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span> =</span> mnt_path.dentry-&gt;d_sb;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sb-&gt;s_op-&gt;show_devname) &#123;</span><br><span class="line">		err = sb-&gt;s_op-&gt;show_devname(m, mnt_path.dentry);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mangle(m, r-&gt;mnt_devname ? r-&gt;mnt_devname : <span class="string">&quot;none&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	seq_putc(m, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">	<span class="comment">/* mountpoints outside of chroot jail will give SEQ_SKIP on this */</span></span><br><span class="line">	err = seq_path_root(m, &amp;mnt_path, &amp;p-&gt;root, <span class="string">&quot; \t\n\\&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	seq_putc(m, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">	show_type(m, sb);</span><br><span class="line">	seq_puts(m, __mnt_is_readonly(mnt) ? <span class="string">&quot; ro&quot;</span> : <span class="string">&quot; rw&quot;</span>);</span><br><span class="line">	err = show_sb_opts(m, sb);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	show_mnt_opts(m, mnt);</span><br><span class="line">	<span class="keyword">if</span> (sb-&gt;s_op-&gt;show_options)</span><br><span class="line">		err = sb-&gt;s_op-&gt;show_options(m, mnt_path.dentry);</span><br><span class="line">	seq_puts(m, <span class="string">&quot; 0 0\n&quot;</span>);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中主要有三个函数输出了options，<code>show_sb_opts()</code>和<code>show_mnt_opts()</code>，还有<code>sb-&gt;s_op-&gt;show_options</code>，其中<code>show_sb_opts()</code>和<code>show_mnt_opts</code>打印的是vfs层面通用的一些选项，比较少。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/proc_namespace.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">show_sb_opts</span><span class="params">(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> super_block *sb)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_fs_opts</span> <span class="title">fs_opts</span>[] =</span> &#123;</span><br><span class="line">		&#123; SB_SYNCHRONOUS, <span class="string">&quot;,sync&quot;</span> &#125;,</span><br><span class="line">		&#123; SB_DIRSYNC, <span class="string">&quot;,dirsync&quot;</span> &#125;,</span><br><span class="line">		&#123; SB_MANDLOCK, <span class="string">&quot;,mand&quot;</span> &#125;,</span><br><span class="line">		&#123; SB_LAZYTIME, <span class="string">&quot;,lazytime&quot;</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0</span>, <span class="literal">NULL</span> &#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_fs_opts</span> *<span class="title">fs_infop</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (fs_infop = fs_opts; fs_infop-&gt;flag; fs_infop++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (sb-&gt;s_flags &amp; fs_infop-&gt;flag)</span><br><span class="line">			seq_puts(m, fs_infop-&gt;str);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> security_sb_show_options(m, sb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">show_mnt_opts</span><span class="params">(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> vfsmount *mnt)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_fs_opts</span> <span class="title">mnt_opts</span>[] =</span> &#123;</span><br><span class="line">		&#123; MNT_NOSUID, <span class="string">&quot;,nosuid&quot;</span> &#125;,</span><br><span class="line">		&#123; MNT_NODEV, <span class="string">&quot;,nodev&quot;</span> &#125;,</span><br><span class="line">		&#123; MNT_NOEXEC, <span class="string">&quot;,noexec&quot;</span> &#125;,</span><br><span class="line">		&#123; MNT_NOATIME, <span class="string">&quot;,noatime&quot;</span> &#125;,</span><br><span class="line">		&#123; MNT_NODIRATIME, <span class="string">&quot;,nodiratime&quot;</span> &#125;,</span><br><span class="line">		&#123; MNT_RELATIME, <span class="string">&quot;,relatime&quot;</span> &#125;,</span><br><span class="line">		&#123; MNT_NOSYMFOLLOW, <span class="string">&quot;,nosymfollow&quot;</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0</span>, <span class="literal">NULL</span> &#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_fs_opts</span> *<span class="title">fs_infop</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (fs_infop = mnt_opts; fs_infop-&gt;flag; fs_infop++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mnt-&gt;mnt_flags &amp; fs_infop-&gt;flag)</span><br><span class="line">			seq_puts(m, fs_infop-&gt;str);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mnt_user_ns(mnt) != &amp;init_user_ns)</span><br><span class="line">		seq_puts(m, <span class="string">&quot;,idmapped&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>sb-&gt;s_op-&gt;show_options</code>，对于<code>ext4</code>文件系统来说，是<code>_ext4_show_options</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/ext4/super.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span> <span class="title">ext4_sops</span> =</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	.show_options	= ext4_show_options,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ext4_show_options</span><span class="params">(<span class="keyword">struct</span> seq_file *seq, <span class="keyword">struct</span> dentry *root)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> _ext4_show_options(seq, root-&gt;d_sb, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Show an option if</span></span><br><span class="line"><span class="comment"> *  - it&#x27;s set to a non-default value OR</span></span><br><span class="line"><span class="comment"> *  - if the per-sb default is different from the global default</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> _ext4_show_options(<span class="keyword">struct</span> seq_file *seq, <span class="keyword">struct</span> super_block *sb,</span><br><span class="line">			      <span class="type">int</span> nodefs)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ext4_sb_info</span> *<span class="title">sbi</span> =</span> EXT4_SB(sb);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ext4_super_block</span> *<span class="title">es</span> =</span> sbi-&gt;s_es;</span><br><span class="line">	<span class="type">int</span> def_errors, def_mount_opt = sbi-&gt;s_def_mount_opt;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mount_opts</span> *<span class="title">m</span>;</span></span><br><span class="line">	<span class="type">char</span> sep = nodefs ? <span class="string">&#x27;\n&#x27;</span> : <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEQ_OPTS_PUTS(str) seq_printf(seq, <span class="string">&quot;%c&quot;</span> str, sep)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEQ_OPTS_PRINT(str, arg) seq_printf(seq, <span class="string">&quot;%c&quot;</span> str, sep, arg)</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sbi-&gt;s_sb_block != <span class="number">1</span>)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;sb=%llu&quot;</span>, sbi-&gt;s_sb_block);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (m = ext4_mount_opts; m-&gt;token != Opt_err; m++) &#123;</span><br><span class="line">		<span class="type">int</span> want_set = m-&gt;flags &amp; MOPT_SET;</span><br><span class="line">		<span class="keyword">if</span> (((m-&gt;flags &amp; (MOPT_SET|MOPT_CLEAR)) == <span class="number">0</span>) ||</span><br><span class="line">		    (m-&gt;flags &amp; MOPT_CLEAR_ERR) || m-&gt;flags &amp; MOPT_SKIP)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (!nodefs &amp;&amp; !(m-&gt;mount_opt &amp; (sbi-&gt;s_mount_opt ^ def_mount_opt)))</span><br><span class="line">			<span class="keyword">continue</span>; <span class="comment">/* skip if same as the default */</span></span><br><span class="line">		<span class="keyword">if</span> ((want_set &amp;&amp;</span><br><span class="line">		     (sbi-&gt;s_mount_opt &amp; m-&gt;mount_opt) != m-&gt;mount_opt) ||</span><br><span class="line">		    (!want_set &amp;&amp; (sbi-&gt;s_mount_opt &amp; m-&gt;mount_opt)))</span><br><span class="line">			<span class="keyword">continue</span>; <span class="comment">/* select Opt_noFoo vs Opt_Foo */</span></span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;%s&quot;</span>, token2str(m-&gt;token));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nodefs || !uid_eq(sbi-&gt;s_resuid, make_kuid(&amp;init_user_ns, EXT4_DEF_RESUID)) ||</span><br><span class="line">	    le16_to_cpu(es-&gt;s_def_resuid) != EXT4_DEF_RESUID)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;resuid=%u&quot;</span>,</span><br><span class="line">				from_kuid_munged(&amp;init_user_ns, sbi-&gt;s_resuid));</span><br><span class="line">	<span class="keyword">if</span> (nodefs || !gid_eq(sbi-&gt;s_resgid, make_kgid(&amp;init_user_ns, EXT4_DEF_RESGID)) ||</span><br><span class="line">	    le16_to_cpu(es-&gt;s_def_resgid) != EXT4_DEF_RESGID)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;resgid=%u&quot;</span>,</span><br><span class="line">				from_kgid_munged(&amp;init_user_ns, sbi-&gt;s_resgid));</span><br><span class="line">	def_errors = nodefs ? <span class="number">-1</span> : le16_to_cpu(es-&gt;s_errors);</span><br><span class="line">	<span class="keyword">if</span> (test_opt(sb, ERRORS_RO) &amp;&amp; def_errors != EXT4_ERRORS_RO)</span><br><span class="line">		SEQ_OPTS_PUTS(<span class="string">&quot;errors=remount-ro&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (test_opt(sb, ERRORS_CONT) &amp;&amp; def_errors != EXT4_ERRORS_CONTINUE)</span><br><span class="line">		SEQ_OPTS_PUTS(<span class="string">&quot;errors=continue&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (test_opt(sb, ERRORS_PANIC) &amp;&amp; def_errors != EXT4_ERRORS_PANIC)</span><br><span class="line">		SEQ_OPTS_PUTS(<span class="string">&quot;errors=panic&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_commit_interval != JBD2_DEFAULT_MAX_COMMIT_AGE*HZ)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;commit=%lu&quot;</span>, sbi-&gt;s_commit_interval / HZ);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_min_batch_time != EXT4_DEF_MIN_BATCH_TIME)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;min_batch_time=%u&quot;</span>, sbi-&gt;s_min_batch_time);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_max_batch_time != EXT4_DEF_MAX_BATCH_TIME)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;max_batch_time=%u&quot;</span>, sbi-&gt;s_max_batch_time);</span><br><span class="line">	<span class="keyword">if</span> (sb-&gt;s_flags &amp; SB_I_VERSION)</span><br><span class="line">		SEQ_OPTS_PUTS(<span class="string">&quot;i_version&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_stripe)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;stripe=%lu&quot;</span>, sbi-&gt;s_stripe);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || EXT4_MOUNT_DATA_FLAGS &amp;</span><br><span class="line">			(sbi-&gt;s_mount_opt ^ def_mount_opt)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (test_opt(sb, DATA_FLAGS) == EXT4_MOUNT_JOURNAL_DATA)</span><br><span class="line">			SEQ_OPTS_PUTS(<span class="string">&quot;data=journal&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (test_opt(sb, DATA_FLAGS) == EXT4_MOUNT_ORDERED_DATA)</span><br><span class="line">			SEQ_OPTS_PUTS(<span class="string">&quot;data=ordered&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (test_opt(sb, DATA_FLAGS) == EXT4_MOUNT_WRITEBACK_DATA)</span><br><span class="line">			SEQ_OPTS_PUTS(<span class="string">&quot;data=writeback&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (nodefs ||</span><br><span class="line">	    sbi-&gt;s_inode_readahead_blks != EXT4_DEF_INODE_READAHEAD_BLKS)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;inode_readahead_blks=%u&quot;</span>,</span><br><span class="line">			       sbi-&gt;s_inode_readahead_blks);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (test_opt(sb, INIT_INODE_TABLE) &amp;&amp; (nodefs ||</span><br><span class="line">		       (sbi-&gt;s_li_wait_mult != EXT4_DEF_LI_WAIT_MULT)))</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;init_itable=%u&quot;</span>, sbi-&gt;s_li_wait_mult);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_max_dir_size_kb)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;max_dir_size_kb=%u&quot;</span>, sbi-&gt;s_max_dir_size_kb);</span><br><span class="line">	<span class="keyword">if</span> (test_opt(sb, DATA_ERR_ABORT))</span><br><span class="line">		SEQ_OPTS_PUTS(<span class="string">&quot;data_err=abort&quot;</span>);</span><br><span class="line"></span><br><span class="line">	fscrypt_show_test_dummy_encryption(seq, sep, sb);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sb-&gt;s_flags &amp; SB_INLINECRYPT)</span><br><span class="line">		SEQ_OPTS_PUTS(<span class="string">&quot;inlinecrypt&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (test_opt(sb, DAX_ALWAYS)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (IS_EXT2_SB(sb))</span><br><span class="line">			SEQ_OPTS_PUTS(<span class="string">&quot;dax&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			SEQ_OPTS_PUTS(<span class="string">&quot;dax=always&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (test_opt2(sb, DAX_NEVER)) &#123;</span><br><span class="line">		SEQ_OPTS_PUTS(<span class="string">&quot;dax=never&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (test_opt2(sb, DAX_INODE)) &#123;</span><br><span class="line">		SEQ_OPTS_PUTS(<span class="string">&quot;dax=inode&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	ext4_show_quota_options(seq, sb);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="proc-fs-ext4-device-options"><a href="#proc-fs-ext4-device-options" class="headerlink" title="&#x2F;proc&#x2F;fs&#x2F;ext4&#x2F;{device}&#x2F;options"></a>&#x2F;proc&#x2F;fs&#x2F;ext4&#x2F;{device}&#x2F;options</h3><p>在ext4文件系统被挂载的时候，会在<code>__ext4_fill_super()</code>里调用<code>ext4_register_sysfs()</code>来注册procfs的条目：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/ext4/sysfs.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ext4_register_sysfs</span><span class="params">(<span class="keyword">struct</span> super_block *sb)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (sbi-&gt;s_proc) &#123;</span><br><span class="line">		proc_create_single_data(<span class="string">&quot;options&quot;</span>, S_IRUGO, sbi-&gt;s_proc,</span><br><span class="line">				ext4_seq_options_show, sb);</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>展示数据的函数为<code>ext4_seq_options_show()</code>，最终也是调用了<code>_ext4_show_options()</code>，不过最后一个参数<code>nodefs</code>为1，导致和<code>/proc/&#123;pid&#125;/mounts</code>的输出不一致。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/ext4/super.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ext4_seq_options_show</span><span class="params">(<span class="keyword">struct</span> seq_file *seq, <span class="type">void</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span> =</span> seq-&gt;private;</span><br><span class="line">	<span class="type">int</span> rc;</span><br><span class="line"></span><br><span class="line">	seq_puts(seq, sb_rdonly(sb) ? <span class="string">&quot;ro&quot;</span> : <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">	rc = _ext4_show_options(seq, sb, <span class="number">1</span>);</span><br><span class="line">	seq_puts(seq, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，导致差异的点有两个，一个是导致sep为’,’还是’\n’；另一个是nodefs为0的情况下，会省略一些选项的输出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> _ext4_show_options(<span class="keyword">struct</span> seq_file *seq, <span class="keyword">struct</span> super_block *sb,</span><br><span class="line">			      <span class="type">int</span> nodefs)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ext4_sb_info</span> *<span class="title">sbi</span> =</span> EXT4_SB(sb);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ext4_super_block</span> *<span class="title">es</span> =</span> sbi-&gt;s_es;</span><br><span class="line">	<span class="type">int</span> def_errors, def_mount_opt = sbi-&gt;s_def_mount_opt;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mount_opts</span> *<span class="title">m</span>;</span></span><br><span class="line">	<span class="type">char</span> sep = nodefs ? <span class="string">&#x27;\n&#x27;</span> : <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sbi-&gt;s_sb_block != <span class="number">1</span>)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;sb=%llu&quot;</span>, sbi-&gt;s_sb_block);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (m = ext4_mount_opts; m-&gt;token != Opt_err; m++) &#123;</span><br><span class="line">		<span class="type">int</span> want_set = m-&gt;flags &amp; MOPT_SET;</span><br><span class="line">		<span class="keyword">if</span> (((m-&gt;flags &amp; (MOPT_SET|MOPT_CLEAR)) == <span class="number">0</span>) ||</span><br><span class="line">		    m-&gt;flags &amp; MOPT_SKIP)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (!nodefs &amp;&amp; !(m-&gt;mount_opt &amp; (sbi-&gt;s_mount_opt ^ def_mount_opt)))</span><br><span class="line">			<span class="keyword">continue</span>; <span class="comment">/* skip if same as the default */</span></span><br><span class="line">		<span class="keyword">if</span> ((want_set &amp;&amp;</span><br><span class="line">		     (sbi-&gt;s_mount_opt &amp; m-&gt;mount_opt) != m-&gt;mount_opt) ||</span><br><span class="line">		    (!want_set &amp;&amp; (sbi-&gt;s_mount_opt &amp; m-&gt;mount_opt)))</span><br><span class="line">			<span class="keyword">continue</span>; <span class="comment">/* select Opt_noFoo vs Opt_Foo */</span></span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;%s&quot;</span>, token2str(m-&gt;token));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nodefs || !uid_eq(sbi-&gt;s_resuid, make_kuid(&amp;init_user_ns, EXT4_DEF_RESUID)) ||</span><br><span class="line">	    le16_to_cpu(es-&gt;s_def_resuid) != EXT4_DEF_RESUID)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;resuid=%u&quot;</span>,</span><br><span class="line">				from_kuid_munged(&amp;init_user_ns, sbi-&gt;s_resuid));</span><br><span class="line">	<span class="keyword">if</span> (nodefs || !gid_eq(sbi-&gt;s_resgid, make_kgid(&amp;init_user_ns, EXT4_DEF_RESGID)) ||</span><br><span class="line">	    le16_to_cpu(es-&gt;s_def_resgid) != EXT4_DEF_RESGID)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;resgid=%u&quot;</span>,</span><br><span class="line">				from_kgid_munged(&amp;init_user_ns, sbi-&gt;s_resgid));</span><br><span class="line">	def_errors = nodefs ? <span class="number">-1</span> : le16_to_cpu(es-&gt;s_errors);</span><br><span class="line">	<span class="keyword">if</span> (test_opt(sb, ERRORS_RO) &amp;&amp; def_errors != EXT4_ERRORS_RO)</span><br><span class="line">		SEQ_OPTS_PUTS(<span class="string">&quot;errors=remount-ro&quot;</span>);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_commit_interval != JBD2_DEFAULT_MAX_COMMIT_AGE*HZ)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;commit=%lu&quot;</span>, sbi-&gt;s_commit_interval / HZ);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_min_batch_time != EXT4_DEF_MIN_BATCH_TIME)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;min_batch_time=%u&quot;</span>, sbi-&gt;s_min_batch_time);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_max_batch_time != EXT4_DEF_MAX_BATCH_TIME)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;max_batch_time=%u&quot;</span>, sbi-&gt;s_max_batch_time);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_stripe)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;stripe=%lu&quot;</span>, sbi-&gt;s_stripe);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || EXT4_MOUNT_DATA_FLAGS &amp;</span><br><span class="line">			(sbi-&gt;s_mount_opt ^ def_mount_opt)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (test_opt(sb, DATA_FLAGS) == EXT4_MOUNT_JOURNAL_DATA)</span><br><span class="line">			SEQ_OPTS_PUTS(<span class="string">&quot;data=journal&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (test_opt(sb, DATA_FLAGS) == EXT4_MOUNT_ORDERED_DATA)</span><br><span class="line">			SEQ_OPTS_PUTS(<span class="string">&quot;data=ordered&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (test_opt(sb, DATA_FLAGS) == EXT4_MOUNT_WRITEBACK_DATA)</span><br><span class="line">			SEQ_OPTS_PUTS(<span class="string">&quot;data=writeback&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (nodefs ||</span><br><span class="line">	    sbi-&gt;s_inode_readahead_blks != EXT4_DEF_INODE_READAHEAD_BLKS)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;inode_readahead_blks=%u&quot;</span>,</span><br><span class="line">			       sbi-&gt;s_inode_readahead_blks);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (test_opt(sb, INIT_INODE_TABLE) &amp;&amp; (nodefs ||</span><br><span class="line">		       (sbi-&gt;s_li_wait_mult != EXT4_DEF_LI_WAIT_MULT)))</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;init_itable=%u&quot;</span>, sbi-&gt;s_li_wait_mult);</span><br><span class="line">	<span class="keyword">if</span> (nodefs || sbi-&gt;s_max_dir_size_kb)</span><br><span class="line">		SEQ_OPTS_PRINT(<span class="string">&quot;max_dir_size_kb=%u&quot;</span>, sbi-&gt;s_max_dir_size_kb);</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来起来主要就是nodefs为1和0的两种情况导致输出不一致。可以看到这段逻辑，如果是default的options，并且nodefs为0，就跳过。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!nodefs &amp;&amp; !(m-&gt;mount_opt &amp; (sbi-&gt;s_mount_opt ^ def_mount_opt)))</span><br><span class="line">	<span class="keyword">continue</span>; <span class="comment">/* skip if same as the default */</span></span><br></pre></td></tr></table></figure>

<p>这里default_options应该就是文档里描述的那些。我先入为主的以为这个就是磁盘上super_block的s_default_opts字段，于是通过tune_2fs查看了下，发现并不是。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tune2fs -l /dev/sdb</span><br><span class="line">tune2fs 1.46.5 (30-Dec-2021)</span><br><span class="line">// ...</span><br><span class="line">Default mount options:    user_xattr acl</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<p>这里只有user_xattr和acl，理论上其他的那些options当nodefs为0时也会输出，比如delalloc。但是却并没有。所以，还得探究下这个<code>sbi-&gt;s_def_mount_opt</code>字段究竟是如何被设置的。</p>
<h2 id="默认挂载选项"><a href="#默认挂载选项" class="headerlink" title="默认挂载选项"></a>默认挂载选项</h2><p>熟悉linux文件系统的都知道，vfs会有个通用的super block，每个文件系统也会有自己的super block，它们在磁盘和在内存上都会有些许差距。对于ext4来说，它在磁盘上的super block布局为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/ext4/ext4.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Structure of the super block</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ext4_super_block</span> &#123;</span></span><br><span class="line"><span class="comment">/*00*/</span>	__le32	s_inodes_count;		<span class="comment">/* Inodes count */</span></span><br><span class="line">	__le32	s_blocks_count_lo;	<span class="comment">/* Blocks count */</span></span><br><span class="line">	__le32	s_r_blocks_count_lo;	<span class="comment">/* Reserved blocks count */</span></span><br><span class="line">	__le32	s_free_blocks_count_lo;	<span class="comment">/* Free blocks count */</span></span><br><span class="line"><span class="comment">/*10*/</span>	__le32	s_free_inodes_count;	<span class="comment">/* Free inodes count */</span></span><br><span class="line">	__le32	s_first_data_block;	<span class="comment">/* First Data Block */</span></span><br><span class="line">	__le32	s_log_block_size;	<span class="comment">/* Block size */</span></span><br><span class="line">	__le32	s_log_cluster_size;	<span class="comment">/* Allocation cluster size */</span></span><br><span class="line"><span class="comment">/*20*/</span>	__le32	s_blocks_per_group;	<span class="comment">/* # Blocks per group */</span></span><br><span class="line">	__le32	s_clusters_per_group;	<span class="comment">/* # Clusters per group */</span></span><br><span class="line">	__le32	s_inodes_per_group;	<span class="comment">/* # Inodes per group */</span></span><br><span class="line">	__le32	s_mtime;		<span class="comment">/* Mount time */</span></span><br><span class="line"><span class="comment">/*30*/</span>	__le32	s_wtime;		<span class="comment">/* Write time */</span></span><br><span class="line">	__le16	s_mnt_count;		<span class="comment">/* Mount count */</span></span><br><span class="line">	__le16	s_max_mnt_count;	<span class="comment">/* Maximal mount count */</span></span><br><span class="line">	__le16	s_magic;		<span class="comment">/* Magic signature */</span></span><br><span class="line">	__le16	s_state;		<span class="comment">/* File system state */</span></span><br><span class="line">	__le16	s_errors;		<span class="comment">/* Behaviour when detecting errors */</span></span><br><span class="line">	__le16	s_minor_rev_level;	<span class="comment">/* minor revision level */</span></span><br><span class="line"><span class="comment">/*40*/</span>	__le32	s_lastcheck;		<span class="comment">/* time of last check */</span></span><br><span class="line">	__le32	s_checkinterval;	<span class="comment">/* max. time between checks */</span></span><br><span class="line">	__le32	s_creator_os;		<span class="comment">/* OS */</span></span><br><span class="line">	__le32	s_rev_level;		<span class="comment">/* Revision level */</span></span><br><span class="line"><span class="comment">/*50*/</span>	__le16	s_def_resuid;		<span class="comment">/* Default uid for reserved blocks */</span></span><br><span class="line">	__le16	s_def_resgid;		<span class="comment">/* Default gid for reserved blocks */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * These fields are for EXT4_DYNAMIC_REV superblocks only.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Note: the difference between the compatible feature set and</span></span><br><span class="line"><span class="comment">	 * the incompatible feature set is that if there is a bit set</span></span><br><span class="line"><span class="comment">	 * in the incompatible feature set that the kernel doesn&#x27;t</span></span><br><span class="line"><span class="comment">	 * know about, it should refuse to mount the filesystem.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * e2fsck&#x27;s requirements are more strict; if it doesn&#x27;t know</span></span><br><span class="line"><span class="comment">	 * about a feature in either the compatible or incompatible</span></span><br><span class="line"><span class="comment">	 * feature set, it must abort and not try to meddle with</span></span><br><span class="line"><span class="comment">	 * things it doesn&#x27;t understand...</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	__le32	s_first_ino;		<span class="comment">/* First non-reserved inode */</span></span><br><span class="line">	__le16  s_inode_size;		<span class="comment">/* size of inode structure */</span></span><br><span class="line">	__le16	s_block_group_nr;	<span class="comment">/* block group # of this superblock */</span></span><br><span class="line">	__le32	s_feature_compat;	<span class="comment">/* compatible feature set */</span></span><br><span class="line"><span class="comment">/*60*/</span>	__le32	s_feature_incompat;	<span class="comment">/* incompatible feature set */</span></span><br><span class="line">	__le32	s_feature_ro_compat;	<span class="comment">/* readonly-compatible feature set */</span></span><br><span class="line"><span class="comment">/*68*/</span>	__u8	s_uuid[<span class="number">16</span>];		<span class="comment">/* 128-bit uuid for volume */</span></span><br><span class="line"><span class="comment">/*78*/</span>	<span class="type">char</span>	s_volume_name[EXT4_LABEL_MAX];	<span class="comment">/* volume name */</span></span><br><span class="line"><span class="comment">/*88*/</span>	<span class="type">char</span>	s_last_mounted[<span class="number">64</span>] __nonstring;	<span class="comment">/* directory where last mounted */</span></span><br><span class="line"><span class="comment">/*C8*/</span>	__le32	s_algorithm_usage_bitmap; <span class="comment">/* For compression */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Performance hints.  Directory preallocation should only</span></span><br><span class="line"><span class="comment">	 * happen if the EXT4_FEATURE_COMPAT_DIR_PREALLOC flag is on.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	__u8	s_prealloc_blocks;	<span class="comment">/* Nr of blocks to try to preallocate*/</span></span><br><span class="line">	__u8	s_prealloc_dir_blocks;	<span class="comment">/* Nr to preallocate for dirs */</span></span><br><span class="line">	__le16	s_reserved_gdt_blocks;	<span class="comment">/* Per group desc for online growth */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Journaling support valid if EXT4_FEATURE_COMPAT_HAS_JOURNAL set.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="comment">/*D0*/</span>	__u8	s_journal_uuid[<span class="number">16</span>];	<span class="comment">/* uuid of journal superblock */</span></span><br><span class="line"><span class="comment">/*E0*/</span>	__le32	s_journal_inum;		<span class="comment">/* inode number of journal file */</span></span><br><span class="line">	__le32	s_journal_dev;		<span class="comment">/* device number of journal file */</span></span><br><span class="line">	__le32	s_last_orphan;		<span class="comment">/* start of list of inodes to delete */</span></span><br><span class="line">	__le32	s_hash_seed[<span class="number">4</span>];		<span class="comment">/* HTREE hash seed */</span></span><br><span class="line">	__u8	s_def_hash_version;	<span class="comment">/* Default hash version to use */</span></span><br><span class="line">	__u8	s_jnl_backup_type;</span><br><span class="line">	__le16  s_desc_size;		<span class="comment">/* size of group descriptor */</span></span><br><span class="line"><span class="comment">/*100*/</span>	__le32	s_default_mount_opts;</span><br><span class="line">	__le32	s_first_meta_bg;	<span class="comment">/* First metablock block group */</span></span><br><span class="line">	__le32	s_mkfs_time;		<span class="comment">/* When the filesystem was created */</span></span><br><span class="line">	__le32	s_jnl_blocks[<span class="number">17</span>];	<span class="comment">/* Backup of the journal inode */</span></span><br><span class="line">	<span class="comment">/* 64bit support valid if EXT4_FEATURE_COMPAT_64BIT */</span></span><br><span class="line"><span class="comment">/*150*/</span>	__le32	s_blocks_count_hi;	<span class="comment">/* Blocks count */</span></span><br><span class="line">	__le32	s_r_blocks_count_hi;	<span class="comment">/* Reserved blocks count */</span></span><br><span class="line">	__le32	s_free_blocks_count_hi;	<span class="comment">/* Free blocks count */</span></span><br><span class="line">	__le16	s_min_extra_isize;	<span class="comment">/* All inodes have at least # bytes */</span></span><br><span class="line">	__le16	s_want_extra_isize; 	<span class="comment">/* New inodes should reserve # bytes */</span></span><br><span class="line">	__le32	s_flags;		<span class="comment">/* Miscellaneous flags */</span></span><br><span class="line">	__le16  s_raid_stride;		<span class="comment">/* RAID stride */</span></span><br><span class="line">	__le16  s_mmp_update_interval;  <span class="comment">/* # seconds to wait in MMP checking */</span></span><br><span class="line">	__le64  s_mmp_block;            <span class="comment">/* Block for multi-mount protection */</span></span><br><span class="line">	__le32  s_raid_stripe_width;    <span class="comment">/* blocks on all data disks (N*stride)*/</span></span><br><span class="line">	__u8	s_log_groups_per_flex;  <span class="comment">/* FLEX_BG group size */</span></span><br><span class="line">	__u8	s_checksum_type;	<span class="comment">/* metadata checksum algorithm used */</span></span><br><span class="line">	__u8	s_encryption_level;	<span class="comment">/* versioning level for encryption */</span></span><br><span class="line">	__u8	s_reserved_pad;		<span class="comment">/* Padding to next 32bits */</span></span><br><span class="line">	__le64	s_kbytes_written;	<span class="comment">/* nr of lifetime kilobytes written */</span></span><br><span class="line">	__le32	s_snapshot_inum;	<span class="comment">/* Inode number of active snapshot */</span></span><br><span class="line">	__le32	s_snapshot_id;		<span class="comment">/* sequential ID of active snapshot */</span></span><br><span class="line">	__le64	s_snapshot_r_blocks_count; <span class="comment">/* reserved blocks for active</span></span><br><span class="line"><span class="comment">					      snapshot&#x27;s future use */</span></span><br><span class="line">	__le32	s_snapshot_list;	<span class="comment">/* inode number of the head of the</span></span><br><span class="line"><span class="comment">					   on-disk snapshot list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_S_ERR_START offsetof(struct ext4_super_block, s_error_count)</span></span><br><span class="line">	__le32	s_error_count;		<span class="comment">/* number of fs errors */</span></span><br><span class="line">	__le32	s_first_error_time;	<span class="comment">/* first time an error happened */</span></span><br><span class="line">	__le32	s_first_error_ino;	<span class="comment">/* inode involved in first error */</span></span><br><span class="line">	__le64	s_first_error_block;	<span class="comment">/* block involved of first error */</span></span><br><span class="line">	__u8	s_first_error_func[<span class="number">32</span>] __nonstring;	<span class="comment">/* function where the error happened */</span></span><br><span class="line">	__le32	s_first_error_line;	<span class="comment">/* line number where error happened */</span></span><br><span class="line">	__le32	s_last_error_time;	<span class="comment">/* most recent time of an error */</span></span><br><span class="line">	__le32	s_last_error_ino;	<span class="comment">/* inode involved in last error */</span></span><br><span class="line">	__le32	s_last_error_line;	<span class="comment">/* line number where error happened */</span></span><br><span class="line">	__le64	s_last_error_block;	<span class="comment">/* block involved of last error */</span></span><br><span class="line">	__u8	s_last_error_func[<span class="number">32</span>] __nonstring;	<span class="comment">/* function where the error happened */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_S_ERR_END offsetof(struct ext4_super_block, s_mount_opts)</span></span><br><span class="line">	__u8	s_mount_opts[<span class="number">64</span>];</span><br><span class="line">	__le32	s_usr_quota_inum;	<span class="comment">/* inode for tracking user quota */</span></span><br><span class="line">	__le32	s_grp_quota_inum;	<span class="comment">/* inode for tracking group quota */</span></span><br><span class="line">	__le32	s_overhead_clusters;	<span class="comment">/* overhead blocks/clusters in fs */</span></span><br><span class="line">	__le32	s_backup_bgs[<span class="number">2</span>];	<span class="comment">/* groups with sparse_super2 SBs */</span></span><br><span class="line">	__u8	s_encrypt_algos[<span class="number">4</span>];	<span class="comment">/* Encryption algorithms in use  */</span></span><br><span class="line">	__u8	s_encrypt_pw_salt[<span class="number">16</span>];	<span class="comment">/* Salt used for string2key algorithm */</span></span><br><span class="line">	__le32	s_lpf_ino;		<span class="comment">/* Location of the lost+found inode */</span></span><br><span class="line">	__le32	s_prj_quota_inum;	<span class="comment">/* inode for tracking project quota */</span></span><br><span class="line">	__le32	s_checksum_seed;	<span class="comment">/* crc32c(uuid) if csum_seed set */</span></span><br><span class="line">	__u8	s_wtime_hi;</span><br><span class="line">	__u8	s_mtime_hi;</span><br><span class="line">	__u8	s_mkfs_time_hi;</span><br><span class="line">	__u8	s_lastcheck_hi;</span><br><span class="line">	__u8	s_first_error_time_hi;</span><br><span class="line">	__u8	s_last_error_time_hi;</span><br><span class="line">	__u8	s_first_error_errcode;</span><br><span class="line">	__u8    s_last_error_errcode;</span><br><span class="line">	__le16  s_encoding;		<span class="comment">/* Filename charset encoding */</span></span><br><span class="line">	__le16  s_encoding_flags;	<span class="comment">/* Filename charset encoding flags */</span></span><br><span class="line">	__le32  s_orphan_file_inum;	<span class="comment">/* Inode for tracking orphan inodes */</span></span><br><span class="line">	__le32	s_reserved[<span class="number">94</span>];		<span class="comment">/* Padding to the end of the block */</span></span><br><span class="line">	__le32	s_checksum;		<span class="comment">/* crc32c(superblock) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>它会有个字段<code>s_default_mount_opts</code>，其实就是tune2fs工具展示的Default mount options，这个值是在磁盘上永久保存的，一般都是当mkfs创建文件系统的时候写入，也可以通过tune2fs工具来修改。</p>
<p>它允许的默认值包括如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/ext4/ext4.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Default mount options</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_DEBUG		0x0001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_BSDGROUPS	0x0002</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_XATTR_USER	0x0004</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_ACL		0x0008</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_UID16		0x0010</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_JMODE		0x0060</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_JMODE_DATA	0x0020</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_JMODE_ORDERED	0x0040</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_JMODE_WBACK	0x0060</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_NOBARRIER	0x0100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_BLOCK_VALIDITY 0x0200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_DISCARD	0x0400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXT4_DEFM_NODELALLOC	0x0800</span></span><br></pre></td></tr></table></figure>

<p>mkfs可以通过配置文件来设置创建文件系统后super block里default_mntopts字段的值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">// /etc/mke2fs.conf</span><br><span class="line">[defaults]</span><br><span class="line">        base_features = sparse_super,large_file,filetype,resize_inode,dir_index,ext_attr</span><br><span class="line">        default_mntopts = acl,user_xattr</span><br><span class="line">        enable_periodic_fsck = 0</span><br><span class="line">        blocksize = 4096</span><br><span class="line">        inode_size = 256</span><br><span class="line">        inode_ratio = 16384</span><br><span class="line"></span><br><span class="line">[fs_types]</span><br><span class="line">        ext3 = &#123;</span><br><span class="line">                features = has_journal</span><br><span class="line">        &#125;</span><br><span class="line">        ext4 = &#123;</span><br><span class="line">                features = has_journal,extent,huge_file,flex_bg,metadata_csum,64bit,dir_nlink,extra_isize</span><br><span class="line">        &#125;</span><br><span class="line">        small = &#123;</span><br><span class="line">                inode_ratio = 4096</span><br><span class="line">        &#125;</span><br><span class="line">        floppy = &#123;</span><br><span class="line">                inode_ratio = 8192</span><br><span class="line">        &#125;</span><br><span class="line">        big = &#123;</span><br><span class="line">                inode_ratio = 32768</span><br><span class="line">        &#125;</span><br><span class="line">        huge = &#123;</span><br><span class="line">                inode_ratio = 65536</span><br><span class="line">        &#125;</span><br><span class="line">        news = &#123;</span><br><span class="line">                inode_ratio = 4096</span><br><span class="line">        &#125;</span><br><span class="line">        largefile = &#123;</span><br><span class="line">                inode_ratio = 1048576</span><br><span class="line">                blocksize = -1</span><br><span class="line">        &#125;</span><br><span class="line">        largefile4 = &#123;</span><br><span class="line">                inode_ratio = 4194304</span><br><span class="line">                blocksize = -1</span><br><span class="line">        &#125;</span><br><span class="line">        hurd = &#123;</span><br><span class="line">             blocksize = 4096</span><br><span class="line">             inode_size = 128</span><br><span class="line">             warn_y2038_dates = 0</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以确定，内存里加载过后的superblock的字段<code>s_def_mount_opt</code>和磁盘上super block的字段<code>s_default_mount_opts</code>实际上并非对应的关系，在内核挂载阶段的内核代码里会对<code>ext4_sb_info -&gt; s_def_mount_opt</code>进行设置。有意思的是，可以在磁盘上的superblock里设置EXT4_DEFM_NODELALLOC，从而改变挂载时默认delalloc的逻辑。</p>
<p>接下来梳理了一下内核代码关于mount option的设置流程：<code>sys_mount()</code> -&gt; <code>do_mount()</code> -&gt; <code>path_mount()</code> -&gt; <code>do_new_mount()</code> -&gt; <code>vfs_get_tree()</code> -&gt; <code>ext4_get_tree()</code> -&gt; <code>get_tree_bdev()</code> -&gt; <code>ext4_fill_super</code> -&gt; <code>__ext4_fill_super()</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/ext4/super.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __ext4_fill_super(<span class="keyword">struct</span> fs_context *fc, <span class="keyword">struct</span> super_block *sb)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ext4_super_block</span> *<span class="title">es</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ext4_sb_info</span> *<span class="title">sbi</span> =</span> EXT4_SB(sb);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">flex_groups</span> **<span class="title">flex_groups</span>;</span></span><br><span class="line">	<span class="type">ext4_fsblk_t</span> block;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">root</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ext4_fs_context</span> *<span class="title">ctx</span> =</span> fc-&gt;fs_private;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 加载sbi-&gt;s_es，es指向磁盘上布局的super block数据</span></span><br><span class="line">	err = ext4_load_super(sb, &amp;logical_sb_block, silent);</span><br><span class="line"></span><br><span class="line">	es = sbi-&gt;s_es;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解析es-&gt;s_default_mount_opts，这也是mkfs时可以设置的挂载options</span></span><br><span class="line">	<span class="comment">// 这个字段为字符串</span></span><br><span class="line">	ext4_set_def_opts(sb, es);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解析es-&gt;s_mount_opts</span></span><br><span class="line">	err = parse_apply_sb_mount_options(sb, ctx);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> failed_mount;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里的赋值很关键，会把上述解析出来的option都列为s_def_mount_opt</span></span><br><span class="line">	sbi-&gt;s_def_mount_opt = sbi-&gt;s_mount_opt;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里在设置挂载时参数附带的options，不再将其设置为s_def_mount_opt</span></span><br><span class="line">	ext4_apply_options(fc, sb);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里也有可能设置sbi-&gt;s_def_mount_opt</span></span><br><span class="line">	<span class="keyword">if</span> (!test_opt(sb, NOLOAD) &amp;&amp; ext4_has_feature_journal(sb)) &#123;</span><br><span class="line">		err = ext4_load_and_init_journal(sb, es, ctx);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">goto</span> failed_mount3a;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过es-&gt;s_default_mount_opts来设置sbi-&gt;s_mount_opt</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ext4_set_def_opts</span><span class="params">(<span class="keyword">struct</span> super_block *sb,</span></span><br><span class="line"><span class="params">			      <span class="keyword">struct</span> ext4_super_block *es)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> def_mount_opts;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set defaults before we parse the mount options */</span></span><br><span class="line">	def_mount_opts = le32_to_cpu(es-&gt;s_default_mount_opts);</span><br><span class="line">	set_opt(sb, INIT_INODE_TABLE);</span><br><span class="line">	<span class="keyword">if</span> (def_mount_opts &amp; EXT4_DEFM_DEBUG)</span><br><span class="line">		set_opt(sb, DEBUG);</span><br><span class="line">	<span class="keyword">if</span> (def_mount_opts &amp; EXT4_DEFM_BSDGROUPS)</span><br><span class="line">		set_opt(sb, GRPID);</span><br><span class="line">	<span class="keyword">if</span> (def_mount_opts &amp; EXT4_DEFM_UID16)</span><br><span class="line">		set_opt(sb, NO_UID32);</span><br><span class="line">	<span class="comment">/* xattr user namespace &amp; acls are now defaulted on */</span></span><br><span class="line">	set_opt(sb, XATTR_USER);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EXT4_FS_POSIX_ACL</span></span><br><span class="line">	set_opt(sb, POSIX_ACL);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span> (ext4_has_feature_fast_commit(sb))</span><br><span class="line">		set_opt2(sb, JOURNAL_FAST_COMMIT);</span><br><span class="line">	<span class="comment">/* don&#x27;t forget to enable journal_csum when metadata_csum is enabled. */</span></span><br><span class="line">	<span class="keyword">if</span> (ext4_has_metadata_csum(sb))</span><br><span class="line">		set_opt(sb, JOURNAL_CHECKSUM);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((def_mount_opts &amp; EXT4_DEFM_JMODE) == EXT4_DEFM_JMODE_DATA)</span><br><span class="line">		set_opt(sb, JOURNAL_DATA);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> ((def_mount_opts &amp; EXT4_DEFM_JMODE) == EXT4_DEFM_JMODE_ORDERED)</span><br><span class="line">		set_opt(sb, ORDERED_DATA);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> ((def_mount_opts &amp; EXT4_DEFM_JMODE) == EXT4_DEFM_JMODE_WBACK)</span><br><span class="line">		set_opt(sb, WRITEBACK_DATA);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (le16_to_cpu(es-&gt;s_errors) == EXT4_ERRORS_PANIC)</span><br><span class="line">		set_opt(sb, ERRORS_PANIC);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (le16_to_cpu(es-&gt;s_errors) == EXT4_ERRORS_CONTINUE)</span><br><span class="line">		set_opt(sb, ERRORS_CONT);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		set_opt(sb, ERRORS_RO);</span><br><span class="line">	<span class="comment">/* block_validity enabled by default; disable with noblock_validity */</span></span><br><span class="line">	set_opt(sb, BLOCK_VALIDITY);</span><br><span class="line">	<span class="keyword">if</span> (def_mount_opts &amp; EXT4_DEFM_DISCARD)</span><br><span class="line">		set_opt(sb, DISCARD);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((def_mount_opts &amp; EXT4_DEFM_NOBARRIER) == <span class="number">0</span>)</span><br><span class="line">		set_opt(sb, BARRIER);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * enable delayed allocation by default</span></span><br><span class="line"><span class="comment">	 * Use -o nodelalloc to turn it off</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!IS_EXT3_SB(sb) &amp;&amp; !IS_EXT2_SB(sb) &amp;&amp;</span><br><span class="line">	    ((def_mount_opts &amp; EXT4_DEFM_NODELALLOC) == <span class="number">0</span>))</span><br><span class="line">		set_opt(sb, DELALLOC);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sb-&gt;s_blocksize == PAGE_SIZE)</span><br><span class="line">		set_opt(sb, DIOREAD_NOLOCK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果之前没有设置过EXT4_MOUNT_JOURNAL_DATA字段，也会将其设置成默认字段</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ext4_load_and_init_journal</span><span class="params">(<span class="keyword">struct</span> super_block *sb,</span></span><br><span class="line"><span class="params">				      <span class="keyword">struct</span> ext4_super_block *es,</span></span><br><span class="line"><span class="params">				      <span class="keyword">struct</span> ext4_fs_context *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* We have now updated the journal if required, so we can</span></span><br><span class="line"><span class="comment">	 * validate the data journaling mode. */</span></span><br><span class="line">	<span class="keyword">switch</span> (test_opt(sb, DATA_FLAGS)) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		<span class="comment">/* No mode set, assume a default based on the journal</span></span><br><span class="line"><span class="comment">		 * capabilities: ORDERED_DATA if the journal can</span></span><br><span class="line"><span class="comment">		 * cope, else JOURNAL_DATA</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (jbd2_journal_check_available_features</span><br><span class="line">		    (sbi-&gt;s_journal, <span class="number">0</span>, <span class="number">0</span>, JBD2_FEATURE_INCOMPAT_REVOKE)) &#123;</span><br><span class="line">			set_opt(sb, ORDERED_DATA);</span><br><span class="line">			sbi-&gt;s_def_mount_opt |= EXT4_MOUNT_ORDERED_DATA;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			set_opt(sb, JOURNAL_DATA);</span><br><span class="line">			sbi-&gt;s_def_mount_opt |= EXT4_MOUNT_JOURNAL_DATA;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> EXT4_MOUNT_ORDERED_DATA:</span><br><span class="line">	<span class="keyword">case</span> EXT4_MOUNT_WRITEBACK_DATA:</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，在挂载的过程中，<code>sbi-&gt;s_def_mount_opt</code>和<code>es-&gt;s_mount_opts</code>并非简单的对应关系，ext4会对<code>sbi-&gt;s_def_mount_opt</code>进行额外的设置。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Ext4文件系统的mount option设置来源有几个地方，一是通过mkfs时在磁盘上的superblock写入，二是挂载时的参数。但是这些和内存中文件系统相关的mount options和default mount options都不是简单的对应关系，ext4会根据其他的信息设置options。</p>
<p>查看ext4挂载选项认准<code>/proc/fs/ext4/&#123;device&#125;/options</code>。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/01/Linux/Linux_uids/" rel="prev" title="Linux访问控制模型和进程凭证">
                  <i class="fa fa-angle-left"></i> Linux访问控制模型和进程凭证
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/10/29/Linux/overlayfs_volatile_option/" rel="next" title="overlayfs挂载选项volatile">
                  overlayfs挂载选项volatile <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Yiyang Chen</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/cyyzero" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"cyyzero","repo":"cyyzero.github.io","client_id":"1185801249b8bbce5127","client_secret":"fbbb24c3e0613419f2505f94baa921f61606bac1","admin_user":"cyyzero","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"94f9df52a3faad454c1dbdf0ba5f0cb7"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
